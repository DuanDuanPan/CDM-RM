# 安全与输入校验增补（v1.1）

## 后端输入验证（DTO + 全局管道）
```ts
// apps/api/src/main.ts（示例）
import { ValidationPipe } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalPipes(new ValidationPipe({ whitelist: true, forbidNonWhitelisted: true, transform: true }));
  await app.listen(process.env.APP_PORT || 4000);
}
bootstrap();
```

## CORS 与 CSRF 策略
- 默认使用 Bearer（Authorization 头）：关闭 Cookie 依赖，避免 CSRF；开启严格 CORS（origin allowlist + headers/credentials 控制）
```ts
// CORS（示例）
app.enableCors({
  origin: [/^https:\/\/.*\.example\.com$/, 'http://localhost:3000'],
  methods: ['GET','POST','PUT','PATCH','DELETE','OPTIONS'],
  allowedHeaders: ['Authorization','Content-Type','x-trace-id'],
  credentials: false,
});
```
- 若使用 Cookie（如 Supabase Auth 存 Cookie）：采用 SameSite=strict/lax + 双提交/自定义 header CSRF token；跨站仅通过受控跳转

## 共享 Schema（可选）
在 `packages/shared` 使用 Zod 描述公共入参/出参，服务端在 DTO 校验前做 schema 校验，前端用于表单/请求本地校验。

## 传输与存储加密
- 传输：全站 TLS；外呼 DOORS/OA 均使用 HTTPS，拒绝明文
- 数据库：Prisma 连接字符串开启 SSL，例如 `?sslmode=require`；托管 PG 配置 `PGSSLMODE=require`
- Redis：Upstash 默认 TLS；本地开发可禁用，生产必须启用
- 对象存储（Supabase Storage）：加密 at-rest；下载使用“签名 URL + 有效期”
```ts
// 签名 URL（示例）
const { data } = await supabase.storage.from('exports').createSignedUrl('cp_1/report.csv', 60);
```

## 日志脱敏（pino.redact 示例）
```ts
import pino from 'pino';
export const logger = pino({
  level: process.env.LOGGER_LEVEL ?? 'info',
  redact: {
    paths: ['req.headers.authorization','user.token','password','secret','body.password'],
    censor: '[REDACTED]'
  }
});
```

---
