# Story 1.2: 代码规范与提交检查

## Status
Ready for Review

## Story
**As a** Maintainer,
**I want** ESLint/Prettier/Husky/lint-staged/commitlint,
**so that** 规范与提交范围被强制。

## Acceptance Criteria
1. ESLint 规则：TS/React/Promise/Prettier；Prettier 单引号/120 列。
2. Husky pre-commit：eslint --fix + prettier -w；commitlint 检查 type/scope。
3. 提交信息与 PR 模板就位。

## Tasks / Subtasks
- [x] 完成 ESLint/Prettier 基线配置（AC: 1）[Source: architecture/adr/0001-epic1-decisions.md#决策与指引]
  - [x] 在根 `package.json`（devDependencies）与 `packages/config/package.json` 安装并声明 `eslint-plugin-react`、`eslint-plugin-react-hooks`、`eslint-plugin-promise`、`eslint-plugin-prettier` 等依赖，保证规则可用。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#cicd-与质量门槛强制]
  - [x] 在 `packages/config/eslint.config.js` 引入 React、Promise、Prettier 相关插件与约束，确保覆盖 TS/React 项并保持 `max-warnings=0`。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#cicd-与质量门槛强制]
  - [x] 更新 `packages/config/prettier.config.cjs` 为 `singleQuote: true`、`printWidth: 120` 等规则，并保持根级 `prettier.config.cjs` 引用共享配置。[Source: architecture/adr/0001-epic1-decisions.md#决策与指引]
  - [x] 在根 `package.json` 补充 `lint:fix`、`format` 类脚本，方便 CLI 与 CI 使用统一命令。[Source: architecture/开发与运行流程development-workflow.md#常用脚本建议在根-packagejson-提供]
- [x] 落地 Husky + lint-staged 提交流程（AC: 2）[Source: architecture/adr/0001-epic1-decisions.md#决策与指引]
  - [x] 安装 `husky`、`lint-staged`、`@commitlint/cli`、`@commitlint/config-conventional` 等依赖，并在根 `package.json` 加入 `prepare: "husky install"`。[Source: architecture/一次性落地清单checklist.md#一次性落地清单]
  - [x] 使用 `#!/bin/sh` 与 `set -e` 创建 `husky/pre-commit`，执行 `npx lint-staged`；在 `package.json`（`"lint-staged"` 字段）或 `.lintstagedrc.cjs` 定义模式，例如 `"{apps,packages,scripts}/**/*.{ts,tsx,js}": ["eslint --fix", "prettier --write"]`。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#版本与环境]
  - [x] 创建 `husky/commit-msg` 脚本执行 `npx commitlint --edit "$1"` 并保持 `set -e`，确保 type/scope 校验严格执行。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#cicd-与质量门槛强制]
- [x] 建立提交与评审协作规范（AC: 3）[Source: architecture/工程与工具链落地结合高收益与相容增强.md#协作模板与检查单]
  - [x] 在 `README.md` 的“开发流程”或新增的 `docs/CONTRIBUTING.md` 小节，记录 Conventional Commits type/scope 要求及提交流程示例。[Source: architecture/adr/0001-epic1-decisions.md#决策与指引]
  - [x] 创建 `.github/PULL_REQUEST_TEMPLATE.md`，包含 lint/format/test/coverage 勾选项及 OpenAPI/安全检查提醒，并说明契约变更需附 `yarn api:*` 输出。[Source: architecture/监控与检查清单结果ci-自动化.md#github-actions-工作流示例githubworkflowsqualityyml]
  - [x] 在 `README.md` 的“质量门槛”小节说明开发前需运行 `yarn lint && yarn prettier:check` 并链接 CI 质量门槛列表。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#cicd-与质量门槛强制]

## Dev Notes
- **Previous Story Insights：** Story 1.1 已建立 Yarn 3 Monorepo 结构与 `packages/config` 配置入口，本故事需要在既有目录中扩展规范而非新增路径。[Source: stories/1.1.yarn-3-workspaces-node-20-lts.md#dev-notes]
- **Data Models：** No specific guidance found in architecture docs.
- **API Specifications：** No specific guidance found in architecture docs。
- **Component Specifications：** 当前改动不触及 UI 组件，保持 `apps/web` 按目录约定组织即可。[Source: architecture/前端架构frontend-architecture.md#组件组织目录约定]
- **File Locations：** ESLint/Prettier/commitlint 配置集中在 `packages/config`，PR 模板存放于 `.github/`，文档规范位于根 README 或补充的 `docs/CONTRIBUTING.md`，并在 `docs` 目录保留引用章节。[Source: architecture/高层架构high-level-architecture.md#仓库结构monorepo]
- **Testing Requirements：** 必须保证 `yarn lint`、`yarn prettier:check` 在 CI 中通过，并遵循测试目录 `__tests__` 约定；pre-commit 应阻止未格式化代码。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#cicd-与质量门槛强制][Source: architecture/测试与覆盖率testing-coverage.md#测试-覆盖率testing--coverage]
- **Technical Constraints：** 规则需包含 TS/React/Promise/Prettier 插件、单引号、120 列；提交流程遵循 Conventional Commits 并通过 commitlint；PR 模板需提示 lint/format/test/coverage 检查。[Source: architecture/adr/0001-epic1-decisions.md#决策与指引][Source: architecture/工程与工具链落地结合高收益与相容增强.md#协作模板与检查单]
- **Structure Notes：** 需把 `packages/config/prettier.config.cjs` 的 `printWidth` 从 100 调整到 120，并保持根 `eslint.config.js` 继续引用共享配置；`.github/PULL_REQUEST_TEMPLATE.md` 为新增文件，路径固定于 `.github/`。[Source: architecture/高层架构high-level-architecture.md#仓库结构monorepo]
- **Implementation Tips：** 推荐将 `lint-staged` 配置写入 `package.json` 的 `"lint-staged"` 字段，模式示例：`"{apps,packages,scripts}/**/*.{ts,tsx,js}": ["eslint --fix", "prettier --write"]`；若需独立文件，可使用 `.lintstagedrc.cjs` 并导出同样数组形式。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#协作模板与检查单]

### Testing
- 在 pre-commit 中执行的 `lint-staged` 阶段需准备一个反例（例如含双引号与多余空格的 TS 文件），验证钩子会调用 `eslint --fix` 与 `prettier --write` 后使 diff 归零；随后在 CI 中运行 `yarn lint`、`yarn prettier:check` 确认通过。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#cicd-与质量门槛强制]
- 根据测试策略，对 `packages/config` 配置可使用最小示例文件置于 `__tests__` 目录验证 lint 规则效果（可作为 smoke 校验）。[Source: architecture/测试与覆盖率testing-coverage.md#测试-覆盖率testing--coverage]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-23 | v1.0 | PO 审核通过，转入待开发 | Bob (Scrum Master) |
| 2025-09-23 | v0.2 | 修正模板结构并补充依赖/文档指引 | Bob (Scrum Master) |
| 2025-09-23 | v0.1 | 创建故事草稿 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex)

### Debug Log References
- 2025-09-23: 本地执行 `yarn install --immutable`（确认锁文件同步）
- 2025-09-23: 本地执行 `yarn lint` / `yarn prettier:check` / `yarn type-check`（全部通过）
- 2025-09-23: 本地验证 `HUSKY=0 npx lint-staged --allow-empty` 与 `echo "feat(ci): smoke" | npx commitlint`

### Completion Notes List
- 引入 React/Promise/Prettier 插件并锁定 Prettier 120 列，新增 `lint:fix`、`format` 脚本。
- 配置 Husky pre-commit、commit-msg 钩子与 `lint-staged`，统一提交前自动修复策略。
- README 增补开发流程、自检要求，新增 `.github/PULL_REQUEST_TEMPLATE.md` 与 Conventional Commits 提示。
- 为 Node 20.14 兼容性锁定 `@stoplight/spectral-*` 版本并补充 `@types/glob` 解决 `yarn type-check` 依赖缺失。
- 扩展 lint/prettier/lint-staged 覆盖 `.cjs/.mjs/.yaml` 等配置文件，并在文档与 PR 模板增加 NFR/SLO 对齐提醒。
- 为 CI 增加 lint-staged 与 commitlint smoke step，确保钩子配置持续有效。

### File List
- README.md
- package.json
- packages/config/package.json
- packages/config/prettier.config.cjs
- packages/config/eslint.config.js
- scripts/export-openapi.js
- yarn.lock
- docs/qa/assessments/1.2-nfr-20250923.md
- docs/qa/assessments/1.2-trace-20250923.md
- .github/PULL_REQUEST_TEMPLATE.md
- .github/workflows/quality.yml
- .husky/commit-msg
- .husky/pre-commit

## QA Results

### Review Date: 2025-09-23

### Reviewed By: Quinn (Test Architect)

### 验证结论
- `corepack yarn install --immutable`、`corepack yarn lint`、`corepack yarn prettier:check`、`corepack yarn type-check` 均执行成功，`yarn.lock` 与 `package.json` 保持一致。
- Quality Gates workflow 已新增 lint-staged / commitlint 烟雾测试步骤，CI 端可验证钩子配置。
- Husky 提交钩子与 lint-staged、commitlint 在本地与 CI 均可运行，AC1-AC3 全部满足。

### 主要发现
1. **锁文件同步完成（Severity: Low）** —— 采用 Corepack Yarn 3.6.1 重新生成锁文件与 `.yarn/install-state.gz`，`@stoplight` 相关依赖通过 resolutions 锁定，兼容 Node 20.14。
2. **CI 质量门槛覆盖（Severity: Low）** —— `.github/workflows/quality.yml` 增加 lint-staged、commitlint 烟雾步骤，并继续执行 lint/format/type-check/test 脚本，确保提交规范。
3. **NFR 提醒扩展（Severity: Low）** —— README 与 PR 模板提示在性能/可靠性受影响时同步更新 NFR/SLO，维护过程性文档。

### 建议行动
- 关注 Yarn 3 警告（如 eslint 版本），在后续故事中计划升级以移除弃用依赖。
- 监控 CI 中 lint-staged 烟雾测试耗时，视团队规模调整样例脚本。
- 新增目录或脚本类型时，记得扩展 `lint-staged` 与 smoke 步骤匹配范围。

### Gate 结论
- Gate 评估：**PASS**（锁文件同步、CI 钩子验证、 lint/format/type-check 全通过）。
- 详见 `docs/qa/gates/1.2-code-standards-commit-checks.yml`。

Gate: PASS → docs/qa/gates/1.2-code-standards-commit-checks.yml

### Review Date: 2025-09-23 (复查)

### Reviewed By: Quinn (Test Architect)

### 复查结论
- 复查时重新执行 `corepack yarn install --immutable`、`corepack yarn lint`、`corepack yarn prettier:check`、`corepack yarn type-check`，全部成功。
- Quality Gates 已新增 lint-staged/commitlint 烟雾测试，确保提交流程在 CI 中受控。
- QA 建议保留对 Yarn 3 弃用依赖的关注，并在新增目录时同步扩展 lint-staged 模式。
