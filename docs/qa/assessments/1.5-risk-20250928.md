# 风险画像：故事 1.5 Swagger/OpenAPI 导出

日期：2025-09-28
评审人：Quinn（Test Architect）

## 风险总览
- 风险总数：4（高：3｜中：1｜低：0｜严重：0）
- 整体风险评分：65/100（存在高风险→建议质量门禁状态为 CONCERNS）
- 关键影响范围：`apps/api` Swagger 路由、`scripts/export-openapi.js`、`.github/workflows/quality.yml`、`packages/api-types`、`packages/api-client`
- 关联验收准则：AC1、AC2、AC3

## 风险矩阵
| 风险ID | 描述 | 概率 | 影响 | 得分 | 等级 | 类别 |
|--------|------|------|------|------|------|------|
| TECH-OPENAPI-001 | 运行时契约与真实控制器/DTO 漂移导致客户端生成错误 | 高 (3) | 中 (2) | 6 | 高 | 技术 |
| SEC-OPENAPI-001 | Swagger 暴露内部或受限端点/服务器信息造成攻面扩大 | 中 (2) | 高 (3) | 6 | 高 | 安全 |
| DATA-OPENAPI-001 | 生成脚本遗漏核心资源/枚举，导致类型与前端状态不一致 | 高 (3) | 中 (2) | 6 | 高 | 数据 |
| OPS-OPENAPI-001 | 契约流水线（Spectral/diff/生成）执行时间长或不稳定导致团队绕过检查 | 中 (2) | 中 (2) | 4 | 中 | 运维 |

## 风险登记簿
### TECH-OPENAPI-001：运行时契约与真实控制器/DTO 漂移
- 触发条件：导出逻辑独立于 Nest 控制器注册，或使用缓存的静态文件；新增/修改接口后未刷新契约。
- 受影响组件：`apps/api` OpenAPI bootstrap、`apps/api/src/modules/*` DTO、`scripts/export-openapi.js`。
- 探测手段：`yarn api:openapi` 对比运行时 `/api/__openapi.json`；OpenAPI diff 结果是否存在大量新增/删除；端到端客户端调用回归。
- 现有控制：Story 1.4 延伸的 CI job 已存在，但目前只关注数据库迁移；旧版风险画像提醒纳入健康检查。
- 缓解措施：
  1. 以 Nest SwaggerModule `createDocument(app, config)` 作为唯一数据源，禁止手写 JSON。
  2. 在契约导出集成测试中断言控制器路由列表与 OpenAPI paths 相符。
  3. 将 diff 工件中的高风险变更（删除/Breaking change）标记为 fail-on-breaking，阻止漂移进入主干。
- 残余风险：低（1×2=2），前提是上述自动对比生效。

### SEC-OPENAPI-001：Swagger 暴露内部或受限端点/服务器信息
- 触发条件：默认公开所有模块，包含内部管理、调试端点，或 `servers` 字段带出内网地址。
- 受影响组件：`apps/api` Swagger 配置、RBAC 装饰器、`quality.yml` 中的 Spectral 规则集。
- 探测手段：Spectral 自定义规则（如 `no-internal-server`）、安全测试扫描、review diff 中的 `securitySchemes` 部分。
- 缓解措施：
  1. 启用 Swagger `DocumentBuilder` 的 include/exclude tag 机制，仅暴露对外 API。
  2. 保持 `servers` 指向公开网关，对内环境通过环境变量注入，禁止硬编码。
  3. 为 `/api/__openapi.json` 增加鉴权或最少维持只允许 Platform 访问（如只允许带 Supabase service key）。
- 残余风险：中（2×2=4），需持续监控 diff 中的敏感字段。

### DATA-OPENAPI-001：生成产物遗漏核心资源/枚举
- 触发条件：脚本未聚合 `packages/shared` 新增枚举；OpenAPI schema 未及时更新；`api:types` 未清理旧产物。
- 受影响组件：`scripts/export-openapi.js`、`packages/api-types`、`packages/api-client`、`docs/openapi.baseline.json`。
- 探测手段：类型生成后执行 type-check；diff 工件中出现“missing schema/enum”；前端 `apps/web` TS 编译失败率。
- 缓解措施：
  1. 将生成流程拆分为 `generate → validate → publish`，验证阶段执行 `tsc --noEmit` 针对消费端。
  2. 对每个核心资源（`requirements`、`rbom`、`diffs`、`changes`）建立 schema 完整度单元测试，断言字段存在。
  3. 在 README/Runbook 加入“新增字段必须更新 OpenAPI + types + shared 常量”的发布检查清单。
- 残余风险：中（2×2=4），依赖工程师流程纪律。

### OPS-OPENAPI-001：契约流水线不稳定导致门禁被绕开
- 触发条件：Spectral ruleset 过严导致噪声、diff 比较开销大、缓存配置不当造成 Turborepo 重复计算。
- 受影响组件：`.github/workflows/quality.yml` contracts job、`reports/` 工件、Turborepo pipeline。
- 探测手段：CI 失败率趋势、`reports/openapi-diff.txt` 体积、PR 中跳过/禁用 contracts job 的次数。
- 缓解措施：
  1. 配置 Turborepo cache key（依赖 `apps/api` 和 `scripts/export-openapi.js`），避免无关改动触发重算。
  2. 在 job 中增加 Spectral warning→error 的白名单管理，降低误报。
  3. 设定强制工件上传并在 PR 模板中要求 Reviewer 确认，以防“跳过 job”行为。
- 残余风险：中（2×2=4），需要持续度量 CI 稳定性。

## 风险驱动测试策略
- **P0**：
  - 1.5-INT-001 确认 `/api/__openapi.json` 与 Nest 控制器一致，覆盖 TECH-OPENAPI-001。
  - 1.5-INT-004 Spectral job 失败即阻断，覆盖 SEC-OPENAPI-001。
- **P1**：
  - 1.5-INT-002 / 1.5-INT-003 验证类型与客户端生成覆盖 DATA-OPENAPI-001。
  - 新增端到端检查：在 `apps/web` 中拉取生成客户端执行 smoke call，确保 enums 可用。
- **P2**：
  - 监控 job 稳定性（OPS-OPENAPI-001），引入定期运行的冷缓存管道演练。

## 部署与监控建议
- 发布前要求 diff 工件中无未解释的 breaking change；若存在需产品/架构签字。
- 将 `/api/__openapi.json` 的访问记录纳入 API Gateway 指标，监控异常爬取或爆量访问。
- 持续跟踪 CI contracts job 失败原因统计，每周回顾一次 Spectral 规则调整。
- 当引入新资源或字段时触发风险复审（尤其是 requirements/rbom schema 变更）。

Risk profile: qa.qaLocation/assessments/1.5-risk-20250928.md
