# Requirements Traceability Matrix

## Story: 1.3 - 测试基线（Vitest/Jest）

### Coverage Summary

- Total Requirements: 3
- Fully Covered: 3 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: web 使用 Vitest；api 使用 Jest 或 Vitest（二选一）

- **Coverage: FULL**
- test_mappings:
  - test_file: 'apps/web/package.json'
    test_case: 'Vitest 脚本与依赖'
    given: '@cdm/web workspace 定义 `test`/`test:watch`
    脚本并声明 Vitest + Testing Library 依赖'
    when: '`yarn workspace @cdm/web test` 执行'
    then: 'Vitest 运行成功并生成覆盖率'
    coverage: full
  - test_file: 'apps/web/vitest.config.ts'
    test_case: 'Vitest 配置含 jsdom、覆盖率阈值与 reports 输出'
    given: '加载 vitest 配置'
    when: '执行 `yarn test:client -- --no-threads`'
    then: '生成 lcov/cobertura/json-summary 到 `reports/coverage/web`，阈值 80% 触发'
    coverage: full
  - test_file: 'apps/web/**tests**/Greeting.test.tsx'
    test_case: 'React 组件与 util 示例'
    given: '渲染 Greeting 组件'
    when: '运行 Vitest'
    then: '断言 UI 行为与 util sum 函数，验证测试框架接线'
    coverage: full
  - test_file: 'apps/api/package.json'
    test_case: 'Jest 脚本与依赖'
    given: '@cdm/api workspace 定义 `test`/`test:watch`
    脚本，安装 Jest、ts-jest、supertest 等依赖'
    when: '`yarn workspace @cdm/api test` 执行'
    then: 'Jest 成功运行'
    coverage: full
  - test_file: 'apps/api/jest.config.ts'
    test_case: 'Jest 覆盖率设定 80% 并输出到 reports'
    given: '加载 Jest 配置'
    when: '执行 `yarn test:server`'
    then: '生成 cobertura/json-summary/LCOV 报告，阈值 80%'
    coverage: full
  - test_file: 'apps/api/**tests**/app.controller.spec.ts'
    test_case: '示例 Controller 集成测试'
    given: '通过 supertest 调用 /health'
    when: 'Jest 执行测试套件'
    then: '断言 200 响应与健康字段'
    coverage: full
  - test_file: 'apps/api/**tests**/app.service.spec.ts'
    test_case: '示例 Service 单元测试'
    given: '调用 AppService.getHealth'
    when: 'Jest 执行'
    then: '断言状态、uptime、timestamp'
    coverage: full

#### AC2: `yarn test:client` / `yarn test:server` 执行通过并生成覆盖率报告，低于门槛即失败

- **Coverage: FULL**
- test_mappings:
  - test_file: 'package.json'
    test_case: '根脚本 `test:client` / `test:server` / `coverage`'
    given: '根 package.json 定义测试脚本并委派至 workspace'
    when: '执行 `yarn test`、`yarn coverage`'
    then: '串行跑通前后端测试并打印覆盖率摘要'
    coverage: full
  - test_file: 'scripts/coverage-summary.cjs'
    test_case: '覆盖率汇总脚本'
    given: '读取 web/api coverage-summary.json'
    when: '运行 `yarn coverage`'
    then: '展示 lines/statements/branches/functions 百分比'
    coverage: full
  - runtime_evidence:
    - `corepack yarn test:client -- --no-threads`（2025-09-23 运行成功，输出 100% 覆盖率）
    - `corepack yarn test:server`（2025-09-23 运行成功，输出 100% 覆盖率）
    - `corepack yarn coverage`（2025-09-23 打印 web/api 覆盖率摘要）

#### AC3: CI 启动最小测试矩阵并上传覆盖率产物

- **Coverage: FULL**
- test_mappings:
  - test_file: '.github/workflows/quality.yml'
    test_case: 'tests 作业运行 Vitest/Jest 并上传工件'
    given: 'Quality Gates workflow 中新增 tests job'
    when: '执行 install → yarn test:client -- --no-threads → yarn test:server → 上传 coverage artifacts'
    then: '生成 `coverage-web`、`coverage-api`、`coverage-metrics` 工件'
    coverage: full
  - runtime_evidence: '本地验证成功（2025-09-23）表明命令可执行；CI 需附加运行截图/日志确认工件上传。'

### Critical Gaps

- 无。所有验收标准已具备可执行测试与覆盖率证据。

### Test Design Recommendations

- 持续监控 CI 耗时（`reports/vitest-metrics.txt` / `reports/jest-metrics.txt`）。
- 后续引入业务测试时扩展 coverage-summary 聚合脚本。

### Trace Hook

Trace matrix: docs/qa/assessments/1.3-trace-20250923.md
