# Story 1.4: Prisma 基线与迁移

## Status

Approved

## Story

**As a** Backend Developer,
**I want** 建立 Prisma schema 与迁移基线,
**so that** 数据模型可以受控演进并具备审计能力。

## Acceptance Criteria

1. 初始化 `prisma/schema.prisma` 并生成首个迁移记录。
2. 覆盖 `requirements` / `metrics` / `rbom_nodes` 等核心表及必要索引。
3. CI 中执行 `prisma migrate deploy` 与最小回滚验证。

## Tasks / Subtasks

- [ ] 建立 Prisma schema 与初始迁移（AC: 1, 2）[Source: architecture/后端架构backend-architecture.md#数据库架构prisma-片段]
  - [ ] 检查根 `package.json` 与 `apps/api/package.json` 是否已声明 `prisma`（devDependency）与 `@prisma/client`（dependency）；若缺失则新增并同步 `yarn.lock`。[Source: architecture/开发与运行流程development-workflow.md#常用脚本建议在根-packagejson-提供]
  - [ ] 根据架构文档校验 `Requirement`、`Metric`、`RbomNode` 等模型字段与约束，确保命名使用 snake_case 并包含 JSONB `extras` 字段。[Source: architecture/后端架构backend-architecture.md#数据库架构prisma-片段][Source: architecture/编码标准与命名约定coding-standards.md#关键规则fullstack-critical-rules]
  - [ ] 使用 `npx prisma migrate dev -n init`（或 `prisma migrate deploy` + `prisma migrate resolve`）生成首个迁移，将产物提交到 `apps/api/prisma/migrations`。[Source: architecture/迁移与回滚migrations-rollback.md#策略]
  - [ ] 为高频筛选字段（如 `Requirement.status`, `Metric.name`, `RbomNode.code`）添加索引；必要时使用 `@@index` 或 raw SQL 迁移满足 GIN/BTREE 要求。[Source: architecture/后端架构backend-architecture.md#数据库架构prisma-片段]
- [ ] 配置数据库工具链与环境校验（AC: 1, 2）[Source: architecture/工程与工具链落地结合高收益与相容增强.md#容器与本地栈]
  - [ ] 在 `apps/api/prisma/schema.prisma` 顶部声明 `generator client` 与 `datasource db`，并确保 `DATABASE_URL` 通过 dotenv-safe/envalid 校验（与 Story 1.9 协同）。[Source: architecture/一次性落地清单checklist.md#一次性落地清单]
  - [ ] 更新 `.env.example` 以及 `README.md` 中“开发流程（Development Workflow）”章节新增 “数据库迁移” 小节；若需更详尽流程，在 `docs/ops/deploy-runbooks.md` 下新增 “Database Migrations” 段落，记录本地 Postgres 连接、迁移/回滚指令与备份注意事项。[Source: architecture/迁移与回滚migrations-rollback.md#流程]
  - [ ] 在根 `package.json` 添加 `prisma:generate`、`prisma:migrate`、`prisma:rollback` 脚本统一调用 `yarn workspace @cdm/api prisma ...`；若仓库存在 `turbo.json`（启用 Turborepo），同步更新管线以包含 `prisma:*` 任务，不存在则记录在 README 中的后续拓展说明。[Source: architecture/开发与运行流程development-workflow.md#常用脚本建议在根-packagejson-提供]
- [ ] 将迁移流程接入 CI（AC: 3）[Source: architecture/监控与检查清单结果ci-自动化.md#github-actions-工作流示例githubworkflowsqualityyml]
  - [ ] 在 `quality.yml` 新增 `db-migrate` 作业：复用 Node 20 缓存、启动 Postgres/Redis 服务，依次执行 `prisma generate`、`prisma migrate deploy`、`prisma migrate diff --from-migrations --to-empty --script` 验证回滚脚本，并上传迁移日志。[Source: architecture/迁移与回滚migrations-rollback.md#流程]
  - [ ] 将 `db-migrate` 结果标记为必需检查，并在 README CI 部分描述数据库流水线如何与 contracts/security/test 作业并行运行。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#cicd-与质量门槛强制]
- [ ] 编写最小迁移验证测试（AC: 3）[Source: docs/qa/assessments/1.4-test-design-20250922.md]
  - [ ] 在 `apps/api/__tests__/migration.spec.ts` 创建集成测试：连接迁移后的数据库，验证核心表/索引存在，并使用 `EXPLAIN` 或 Prisma 查询断言索引命中。[Source: architecture/后端架构backend-architecture.md#数据库架构prisma-片段]
  - [ ] 在 `package.json` 增加 `test:migrate`，CI 中于 `db-migrate` 作业执行，确保迁移可重复并满足覆盖率策略。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#测试策略]

## Dev Notes

- **Previous Story Insights：** Story 1.3 已建立 `yarn test:server` 与覆盖率脚本，可复用其 CI 基线，将迁移验证纳入新的 `db-migrate` 作业；Story 1.2 的 Husky/commitlint 已强制提交前运行 lint/format。[Source: stories/1.3.test-baseline-vitest-jest.md#dev-notes][Source: stories/1.2.code-standards-commit-checks.md#dev-notes]
- **Data Models：** Prisma schema 需包含 Requirement/Metric/RbomNode 及后续故事依赖的基线模型，字段结构以架构文档为准，后续可扩展指标/差异等模型。[Source: architecture/后端架构backend-architecture.md#数据库架构prisma-片段]
- **API Specifications：** 迁移完成后需确保 Repository/Service 可读取新表；接口变更暂不涉及，关注数据库层即可。[Source: architecture/组件与流程components-workflows.md#组件清单职责与边界]
- **Component Specifications：** Nest 模块层需引入 PrismaService 并通过依赖注入使用；保持模块化拆分（import/diffs/rbom 等）。[Source: architecture/组件与流程components-workflows.md#组件清单职责与边界]
- **File Locations：** Prisma 相关文件位于 `apps/api/prisma`；生成的客户端输出 `node_modules/.prisma`（默认），可选将共享类型导出到 `packages/shared`；迁移脚本放置于 `apps/api/prisma/migrations`。[Source: architecture/高层架构high-level-architecture.md#仓库结构monorepo]
- **Testing Requirements：** 集成测试使用 Jest（Story 1.3 基线），执行前通过 `cross-env DATABASE_URL=...` 指向临时数据库；覆盖率策略保持 80%。[Source: docs/qa/assessments/1.4-test-design-20250922.md]
- **Technical Constraints：** 所有迁移需可回滚、幂等；高风险 DDL 拆分；索引策略需记录在迁移描述与 README 中；JSONB 字段操作需结合架构中的性能建议。[Source: architecture/迁移与回滚migrations-rollback.md#策略][Source: architecture/编码标准与命名约定coding-standards.md#关键规则fullstack-critical-rules]
- **Structure Notes：** 现有 `scripts/workspace-smoke.cjs` 可更新以调用 `prisma db pull` 或简单查询验证连接，确保老脚本仍可用于快速诊断。[Source: stories/1.1.yarn-3-workspaces-node-20-lts.md#dev-notes]
- **Documentation Tips：** 生成迁移后在 `apps/api/prisma/README.md`（若不存在则创建）记录命名规范、索引策略与回滚剧本，方便后续审计与安全评估。[Source: architecture/迁移与回滚migrations-rollback.md#流程]

### Testing

- 运行 `yarn prisma:migrate` 在本地初始化数据库，并执行 `yarn test:migrate` 验证索引与迁移成功；CI `db-migrate` 作业需上传迁移日志与差异脚本供审计。[Source: docs/qa/assessments/1.4-test-design-20250922.md][Source: architecture/监控与检查清单结果ci-自动化.md#github-actions-工作流示例githubworkflowsqualityyml]

## Change Log

| Date       | Version | Description                                     | Author             |
| ---------- | ------- | ----------------------------------------------- | ------------------ |
| 2025-09-23 | v0.3    | PO 审核通过，转入待开发                         | Bob (Scrum Master) |
| 2025-09-23 | v0.2    | 补充 Prisma 依赖校验、文档章节与 Turborepo 指引 | Bob (Scrum Master) |
| 2025-09-23 | v0.1    | 创建故事草稿                                    | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
