# 需求可追溯矩阵：故事 1.5 Swagger/OpenAPI 导出

日期：2025-09-28｜评审人：Quinn（Test Architect）
规划参考：qa.qaLocation/assessments/1.5-test-design-20250928.md

## 覆盖摘要
- 总需求：4（AC×3｜NFR×1）
- 完整覆盖：3（75%）
- 部分覆盖：1（25%）
- 未覆盖：0（0%）

## 需求映射

### AC1：暴露 `/api/__openapi.json`
- **覆盖级别：FULL**
- **测试映射：**
  - `tests/apps/api/openapi-route.int.test.ts`｜用例 `should expose live OpenAPI document`
    - Given：Nest 应用加载全部公开模块
    - When：调用 GET `/api/__openapi.json`
    - Then：返回 200 且 paths 覆盖所有注册控制器（映射 TECH-OPENAPI-001）
  - `tests/apps/api/openapi-route.diff.test.ts`｜用例 `should flag breaking contract changes`
    - Given：存在最新运行时契约与基线文件
    - When：执行 diff 检查
    - Then：检测到删除/Breaking 时失败并生成报告

### AC2：生成类型与客户端包
- **覆盖级别：FULL**
- **测试映射：**
  - `tests/scripts/api-types.int.test.ts`｜用例 `should emit types for core resources`
    - Given：执行 `yarn api:types`
    - When：生成 `packages/api-types/src/index.ts`
    - Then：包含 `requirements`、`rbom`、`diffs`、`changes` 类型与枚举
  - `tests/scripts/api-client.int.test.ts`｜用例 `should publish axios client`
    - Given：执行 `yarn api:client`
    - When：构建客户端并在 `apps/web` 引入
    - Then：TS 构建通过且调用统一服务层（映射 DATA-OPENAPI-001）
  - `tests/apps/web/no-handcrafted-rest.lint.test.ts`
    - Given：扫描 `apps/web`
    - When：Lint 规则检测手写 REST 路径
    - Then：确保所有调用均来自生成客户端

### AC3：Spectral Lint 通过；OpenAPI diff 报告生成
- **覆盖级别：FULL**
- **测试映射：**
  - `tests/scripts/spectral.int.test.ts`｜用例 `should produce SARIF without blockers`
    - Given：准备 Spectral 配置与规范文件
    - When：运行 `yarn api:spectral`
    - Then：生成 `reports/spectral.sarif` 且无 Blocker 级别问题（映射 SEC-OPENAPI-001）
  - `tests/ci/contracts.e2e.test.ts`｜用例 `should run contracts workflow under cold cache`
    - Given：GitHub Actions `quality.yml` contracts 作业冷缓存启动
    - When：执行流水线
    - Then：Spectral、diff、types、client 全部产出并上传 artifact
  - `tests/scripts/openapi-config.unit.test.ts`
    - Given：加载 Swagger DocumentBuilder 配置
    - When：渲染 OpenAPI 文档
    - Then：仅包含允许公开的 tags 与外网服务器地址

### NFR-OPS：契约流水线稳定性与可监控性
- **覆盖级别：PARTIAL**
- **测试映射：**
  - `tests/ci/contracts.e2e.test.ts`｜用例 `should run contracts workflow under cold cache`
    - Given：禁用 Turborepo 缓存
    - When：执行 contracts 作业
    - Then：流程在 15 分钟内完成且失败会阻断 PR（覆盖 OPS-OPENAPI-001）
- **缺口说明：** 缺少持续监控 CI 失败率与 Spectral 误报的自动化脚本；需要引入指标采集或周期性审查作业日志。

## 覆盖缺口
1. **NFR-OPS**（部分覆盖）
   - 缺口：未自动收集 contracts 作业失败比率及运行时长指标。
   - 建议：新增 GitHub Actions Insights 导出脚本或 Datadog 仪表盘，设定阈值告警；在 `quality.yml` 内部增加 post-job 统计上报。

## Gate YAML 输出
```yaml
trace:
  totals:
    requirements: 4
    full: 3
    partial: 1
    none: 0
  planning_ref: qa.qaLocation/assessments/1.5-test-design-20250928.md
  uncovered:
    - ac: 'NFR-OPS'
      reason: '缺少 CI 稳定性与 Spectral 噪声的持续监控脚本，当前仅手动审查'
  notes: 'See qa.qaLocation/assessments/1.5-trace-20250928.md'
```

Trace matrix: qa.qaLocation/assessments/1.5-trace-20250928.md
