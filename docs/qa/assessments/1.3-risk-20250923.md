# 风险画像：Story 1.3 测试基线（Vitest / Jest）

日期：2025-09-23｜评审：Quinn（测试架构师）

## 概览

- 风险总数：6
- 高风险：4
- 中风险：1
- 低风险：1
- 风险评分：60 / 100（起始 100，4×高风险扣 40，1×中风险扣 5）

## 风险矩阵

| 风险 ID  | 描述                                                                                              | 概率   | 影响   | 评分 | 等级 |
| -------- | ------------------------------------------------------------------------------------------------- | ------ | ------ | ---- | ---- |
| TECH-201 | 在 Yarn 3 Workspaces 内同时接入 Vitest（前端）与 Jest（后端）时配置失败                           | 高 (3) | 中 (2) | 6    | 高   |
| TECH-202 | Node 20 与 ts-jest / ESM 配置不兼容导致 `yarn test:server` 无法运行                               | 中 (2) | 高 (3) | 6    | 高   |
| OPS-201  | 覆盖率阈值 ≥80% 与示例测试数量不匹配，CI 持续失败                                                 | 高 (3) | 中 (2) | 6    | 高   |
| OPS-202  | 根脚本从 `test:web` / `test:api` 迁移至 `test:client` / `test:server`，现有 workflow / 文档未同步 | 中 (2) | 高 (3) | 6    | 高   |
| OPS-203  | 新增测试作业与覆盖率上传增加 CI 耗时与缓存体积                                                    | 中 (2) | 中 (2) | 4    | 中   |
| BUS-201  | 基线仅含样例测试引发“覆盖率已满足”的错觉，延误真实业务测试投入                                    | 低 (1) | 中 (2) | 2    | 低   |

## 详细风险登记

### TECH-201：Vitest / Jest 双框架集成失败

- **迹象**：`apps/web/package.json` 与 `apps/api/package.json` 仍是 TODO 脚本，尚未安装核心依赖。
- **后果**：无法满足 AC1，`yarn test:client` / `yarn test:server` 无法执行。
- **缓解**：
  - 明确依赖清单并一次性写入 `package.json` 与 `yarn.lock`。
  - 在 PR 附上本地 `yarn test:client --coverage` 与 `yarn test:server --coverage` 日志。
  - 为路径别名、Testing Library 初始化提供模板 (`vitest.config.ts`, `vitest.setup.ts`)。
- **测试重点**：双端测试在本地与 CI 均运行，生成 `reports/coverage/web` 与 `reports/coverage/api`。

### TECH-202：Node 20 与 ts-jest / ESM 兼容性

- **迹象**：后端计划用 Jest + ts-jest，需与 Node 20、ESM/TS 解析兼容；若配置不当，会抛出 transform 错误或缺少 `extensionsToTreatAsEsm`。
- **后果**：后端测试无法运行或覆盖率文件未生成，AC1/AC2 均失败。
- **缓解**：
  - 使用 `jest@29` + `ts-jest@29`，开启 `useESM: true` 或转为 `babel-jest`。
  - 在 README 记录 Node/Jest 版本约束及调试指引。
  - CI 执行 `node --version`、`yarn test:server --runInBand --coverage`，检验 `coverage-final.json` 存在。

### OPS-201：覆盖率阈值导致 CI 失败

- **迹象**：仓库仍是骨架代码（如 `packages/shared/src/index.ts` 返回 `null`），若阈值设为 80%，示例测试覆盖不足将触发失败。
- **后果**：质量门槛红灯，阻塞主干发布。
- **缓解**：
  - 设计示例逻辑以确保覆盖率达标；必要时分层阈值（单元 80%，集成 60%）。
  - 在故事内记录未来要逐步提升阈值计划，避免长期停留在样例级别。
  - QA 审查时验证覆盖率报表与阈值配置。

### OPS-202：脚本迁移引发回归

- **迹象**：Story 要求用 `yarn test:client` / `yarn test:server` 替换既有 `test:web` / `test:api`。目前 `.github/workflows/quality.yml` 与 README 都引用旧命令。
- **后果**：若未同步更新，CI 及文档仍运行旧脚本（当前仍为 smoke），导致测试基线落空或命令 404。
- **缓解**：
  - 在同一提交中同步更新 root scripts、workspace scripts、workflow 及 README/PR 模板。
  - 供应向后兼容 alias（例如在 Story 结束前临时保留旧命令调用新脚本），分阶段迁移。
  - QA 在评审时执行 `yarn test:web`、`yarn test:client` 确认证令正确映射，并检查 workflow diff。

### OPS-203：CI 耗时与缓存压力

- **迹象**：Quality Gates 已包含 contracts/security 作业；新增 `tests` job 执行两套测试并上传覆盖率，可能增加 2-4 分钟及数 MB 工件。
- **后果**：CI 队列延迟、缓存失效或作业超时，影响迭代效率。
- **缓解**：
  - 复用 `actions/setup-node@v4` 缓存；使用 `--runInBand --coverage` 控制并发。
  - 压缩上传的覆盖率文件；仅保留 `lcov`, `summary`, `cobertura`。
  - 首个运行后记录耗时与体积，超阈值时拆分 client / server。

### BUS-201：基线造成过度乐观

- **迹象**：任务强调“示例测试”，但未明示真实业务测试责任。
- **后果**：团队误以为覆盖率目标已达成，后续功能缺乏测试投入。
- **缓解**：
  - README / docs/qa 标注“基线仅示范，新增功能需补齐测试”。
  - 在 PR 模板增加“是否新增/更新测试”复选框，并要求附覆盖率变化说明。

## 风险驱动测试策略

1. **P0（高风险）**：
   - 本地 & CI 同步执行 `yarn test:client --coverage --no-threads`、`yarn test:server --coverage --runInBand`。
   - 验证覆盖率阈值触发机制（故意调低覆盖率观察失败）。
   - 确认旧命令 `yarn test:web/api` 若保留 alias，能调用新流程。
2. **P1（中风险）**：
   - 记录 CI 执行耗时、上传工件大小；必要时拆分 job 或按 matrix 运行。
3. **P2（低风险）**：
   - 更新 PR 模板与文档，导入覆盖率报告可视化（徽章或链接）。

## 必须在交付前完成的缓解项

- 同步 `package.json` 与 `yarn.lock`，确保全部测试依赖可安装（`corepack yarn install --immutable` 必须通过）。
- 实现并验证新的测试脚本 / workflow；提交中附运行日志与覆盖率快照。
- 更新 README、docs、PR 模板，确保开发者与 CI 使用一致命令，并注明阈值/未来提升计划。

---

Risk profile: docs/qa/assessments/1.3-risk-20250923.md
