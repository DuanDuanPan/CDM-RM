# Story 1.5: Swagger/OpenAPI 导出

## Status

Done

## Story

**As a** API Owner,
**I want** 暴露 Swagger/OpenAPI 契约并驱动类型/客户端生成,
**so that** 前后端共享一致的接口定义与治理流程。

## Acceptance Criteria

1. 路由暴露 `/api/__openapi.json`（或 yaml）。
2. `api:types`/`api:client` 生成类型与客户端包。
3. Spectral Lint 通过；OpenAPI diff 报告生成。

## Tasks / Subtasks

- [x] 实现运行时 OpenAPI 契约导出（AC: 1, 3）[Source: architecture/工程与工具链落地结合高收益与相容增强.md#契约与-api-参考流水线]
  - [x] 在 `apps/api` 引入并安装 `@nestjs/swagger` 与 `swagger-ui-express`（或团队既定适配库），同步更新 `apps/api/package.json` 与根锁文件，避免运行时缺少依赖。[Source: docs/prd/4-technical-assumptions.md]
  - [x] 在 `apps/api/src/main.ts`（或专用 bootstrap 模块）注册 `SwaggerModule`，导出最新规范到内存并映射 GET `/api/__openapi.json`，保持统一错误模型/鉴权上下文。[Source: architecture/api-规范rest-openapi-30.md#基本约定]
  - [x] 将路由纳入健康/可用性校验，扩展 `quality.yml` 和 README/Runbook 说明契约检查所需服务依赖，确保 CI 在启动 API 后再抓取规范。[Source: docs/qa/assessments/1.5-risk-20250922.md#测试策略]
- [x] 落地契约生成流水线脚本（AC: 2, 3）[Source: architecture/开发与运行流程development-workflow.md#常用脚本建议在根-packagejson-提供]
  - [x] 校验并补充 `scripts/export-openapi.js` 输出 `docs/openapi.json`，在 README 与 `docs/ops/ci-security.md` Runbook 中新增“刷新 OpenAPI”章节指引执行 `yarn api:openapi`。[Source: docs/ops/ci-security.md#4-本地快速校验]
  - [x] 确保 `api:types` 输出到 `packages/api-types/src/index.ts` 且保留团队自定义导出，同时在 `api:client` 生成流程中配置输出到 `packages/api-client/src`，最后经 `index.ts` 聚合，避免覆盖包级元数据。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#契约与-api-参考流水线]
- [x] 把 Spectral Lint 与 OpenAPI diff 纳入 CI 契约工件（AC: 3）[Source: architecture/监控与检查清单结果ci-自动化.md#github-actions-工作流示例githubworkflowsqualityyml]
  - [x] 在 `quality.yml` 的 contracts 作业中继续上传 `reports/spectral.sarif` 与 `reports/openapi-diff.txt`，并在工件描述中标明失败时的调查步骤与责任角色。[Source: architecture/监控与检查清单结果ci-自动化.md#报告产物与路径约定]
  - [x] 更新 `docs/openapi.baseline.json` 的维护流程：在 Runbook 中记录何时刷新基线、如何在 PR 附加 diff 说明以及需要的 Reviewer（API Owner/QA）签字流程。[Source: docs/ops/ci-security.md#3-基线管理建议]
- [x] 前后端同步契约消费（AC: 2）[Source: architecture/前端架构frontend-architecture.md#前端服务层openapi-客户端封装]
  - [x] 新建 `apps/web/lib/api/client.ts`（若不存在）并输出 `serverApi()`/`browserApi()` 等封装，确保前端通过 `packages/api-client` 调用，禁止手写 REST 路径；同时在 README“前端服务层”小节补充使用示例。[Source: architecture/编码标准与命名约定coding-standards.md#关键规则fullstack-critical-rules]
  - [x] 针对新增枚举/资源在 `packages/shared` 中补充类型映射或常量，与 API 规范中码值保持一致，避免重复定义。[Source: architecture/api-规范rest-openapi-30.md#枚举码值与-i18n-映射展示]
- [x] 补充契约测试覆盖（AC: 1, 2, 3）[Source: docs/qa/assessments/1.5-test-design-20250922.md#场景与覆盖]
  - [x] 在 `apps/api/__tests__/openapi.spec.ts` 编写集成测试：启动 Nest 应用后请求 GET `/api/__openapi.json` 并断言 200/JSON 结构、`info.version` 与授权字段等关键内容。[Source: docs/qa/assessments/1.5-test-design-20250922.md#场景与覆盖]
  - [x] 在 CI 合约阶段执行 `yarn api:types`、`yarn api:client` 并断言产物目录存在，可通过脚本或 Jest 测试校验生成文件，防止目录缺失。[Source: docs/qa/assessments/1.5-test-design-20250922.md#场景与覆盖]

## Dev Notes

- **Previous Story Insights：** Story 1.4 于 `.github/workflows/quality.yml` 新增 `db-migrate` 作业并扩充 README/Runbook，可沿用同样结构补充契约检查阶段；Story 1.3 已建立测试脚本与覆盖率基线，可追加契约生成脚本以维持统一命令体系。[Source: stories/1.4.prisma-baseline-migrations.md#tasks--subtasks][Source: stories/1.3.test-baseline-vitest-jest.md#dev-notes]
- **Data Models：** OpenAPI 需覆盖 `requirements`、`rbom`、`diffs`、`changes` 等核心资源，字段命名与枚举值参照规范文档，保持分页、状态与返回结构一致。[Source: architecture/api-规范rest-openapi-30.md#主要端点节选]
- **API Specifications：** API 基路径 `/api`，请求需携带 `Authorization: Bearer <Supabase JWT>`；统一错误格式 `{ error: { code, message, details?, timestamp, requestId } }`，响应头回传 `x-trace-id`；Swagger 导出需与这些约定保持同步。[Source: architecture/api-规范rest-openapi-30.md#基本约定][Source: architecture/编码标准与命名约定coding-standards.md#关键规则fullstack-critical-rules]
- **Component Specifications：** 后端遵循 Controller → Service → Repository 分层，将 Swagger 初始化逻辑集中在 `apps/api/src/main.ts` 或 `modules/contracts`；前端服务层位于 `apps/web/lib/api`，通过 `packages/api-client` 统一调用避免手写 URL。[Source: architecture/后端架构backend-architecture.md#服务架构nestjs-传统服务][Source: architecture/前端架构frontend-architecture.md#前端服务层openapi-客户端封装]
- **File Locations：** 契约脚本位于 `scripts/export-openapi.js`；生成类型产出 `packages/api-types/src/index.ts`，客户端产物位于 `packages/api-client/src` 并在 `index.ts` 聚合；Runbook 位置为 `docs/ops/ci-security.md`；基线文件为 `docs/openapi.baseline.json`。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#monorepo-与目录][Source: docs/ops/ci-security.md#3-基线管理建议]
- **Testing Requirements：** 必须执行 `yarn api:openapi`→`yarn api:spectral`→`yarn api:diff` 流程；按照测试设计补齐 GET `/api/__openapi.json` 集成测试、生成脚本产出校验以及 CI SARIF/diff 工件上传，测试结果需纳入质量报告。[Source: docs/qa/assessments/1.5-test-design-20250922.md#场景与覆盖][Source: architecture/监控与检查清单结果ci-自动化.md#报告产物与路径约定]
- **Technical Constraints：** OpenAPI diff 与 Spectral 是必过门槛，需保持 Yarn 3/Turborepo 缓存有效；生成器覆盖 `packages/api-client` 时需通过输出到 `src/` + `index.ts` 聚合保护 package 元数据；更新基线需要 API Owner 与 QA 审阅并在 PR 中附 diff 说明。[Source: docs/ops/ci-security.md#3-基线管理建议][Source: architecture/监控与检查清单结果ci-自动化.md#github-actions-工作流示例githubworkflowsqualityyml]
- **Structure Notes：** 保持 `apps/*` + `packages/*` + `scripts/` 结构；Swagger 初始化若抽出模块，放于 `apps/api/src/modules/contracts` 与既有层次一致；Runbook 中附 Spectral 规则集（如 `spectral.yaml`）与 diff 工具配置路径，便于长期维护。[Source: architecture/高层架构high-level-architecture.md#仓库结构monorepo][Source: docs/ops/ci-security.md#4-本地快速校验]

### Testing

- 运行集成测试验证 GET `/api/__openapi.json` 返回 200 与有效 JSON；执行 `yarn api:types`、`yarn api:client` 并断言产物目录及关键导出存在；CI 应输出并上传 `reports/spectral.sarif` 与 `reports/openapi-diff.txt`，并在失败时附调查指引。[Source: docs/qa/assessments/1.5-test-design-20250922.md#场景与覆盖][Source: architecture/监控与检查清单结果ci-自动化.md#报告产物与路径约定]

## Change Log

| Date       | Version | Description                | Author |
| ---------- | ------- | -------------------------- | ------ |
| 2025-09-28 | v0.3    | PO 审核通过，转入待开发     | Sarah (Product Owner) |
| 2025-09-28 | v0.2    | 调整草稿以满足审查意见     | Bob    |
| 2025-09-28 | v0.1    | 创建故事草稿               | Bob    |

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex CLI（dev persona）
### Debug Log References

- `yarn api:openapi`
- `yarn build:contracts`
- `yarn build:contracts`
- `yarn lint`
- `yarn prettier:check`
- `yarn type-check`
- `yarn test`
### Completion Notes List

- `/api/__openapi.json` 与 `/api/docs` 现强制依赖 `OPENAPI_SERVICE_KEY`，并通过 `OPENAPI_ALLOWED_TAGS` / `OPENAPI_EXCLUDED_TAGS` / `OPENAPI_HIDE_SERVERS` / `OPENAPI_PUBLIC_SERVER_URL` 控制暴露范围；新增集成测试覆盖鉴权、标签过滤与服务器脱敏。
- `OpenApiStateService` 提供 `getDocument()` 便于断言生成契约，新增健康检查、Express 路由与 OpenAPI paths 对齐的测试。
- `@cdm/api-client` 生成脚本消除 `ApiError` 重名，前端客户端通过 `HealthService` facade 统一访问并在 Vitest 中验证配置覆盖率 >80%。
- `yarn api:diff` 切换为 `@redocly/openapi-cli diff --fail-on-changed`，contracts 作业输出 `reports/contracts-metrics.txt` 供稳定性/耗时监控使用。
- `.env` / `.env.example`、README 及运维文档更新，明确 `OPENAPI_SERVICE_KEY` 必填与标签白名单/服务器脱敏策略，并在 CI 文档中补充 contracts 指标上传说明。
### File List

- `.github/workflows/quality.yml`
- `README.md`
- `package.json`
- `.env`
- `.env.example`
- `apps/api/jest.config.ts`
- `apps/api/jest.setup.ts`
- `apps/api/tsconfig.json`
- `apps/api/src/config/env.ts`
- `apps/api/src/openapi/openapi-state.service.ts`
- `apps/api/src/openapi/setup-openapi.ts`
- `apps/api/src/app.service.ts`
- `apps/api/__tests__/openapi.spec.ts`
- `apps/web/__tests__/apiClient.test.ts`
- `apps/web/lib/api/client.ts`
- `docs/ops/ci-security.md`
- `docs/ops/day0-readiness.md`
- `docs/ops/deploy-runbooks.md`
- `docs/qa/gates/1.5-swagger-openapi-export.yml`
- `packages/config/eslint.config.js`
- `packages/config/tsconfig.base.json`
- `scripts/export-openapi.js`
- `scripts/validate-env.cjs`
## QA Results

- 2025-09-28：风险画像已更新至 `docs/qa/assessments/1.5-risk-20250928.md`，当前门禁建议为 CONCERNS，需完成高风险缓解动作后再审。
- 2025-09-28：测试设计已更新至 `docs/qa/assessments/1.5-test-design-20250928.md`，共计 8 个场景（P0×3｜P1×4｜P2×1），覆盖所有验收准则与主要风险。
- 2025-09-28：需求追踪矩阵已更新至 `docs/qa/assessments/1.5-trace-20250928.md`，4 项需求中 3 项完全覆盖，NFR-OPS 需补充 CI 稳定性监控以达成 FULL。
- 2025-09-28：NFR 评估已更新至 `docs/qa/assessments/1.5-nfr-20250928.md`，当前安全与可靠性存在 CONCERNS，质量分数 80/100。
- 2025-09-28：Gate 决策更新为 PASS。依据：已启用 `x-openapi-key`/Bearer 受控访问，默认仅暴露允许标签并隐藏内部 servers；`yarn api:diff` 采用 `@redocly/openapi-cli diff --fail-on-changed --fail-on-unclassified`，严格覆盖 breaking 变更；CI contracts 作业产出并记录耗时指标。详见 `docs/qa/gates/1.5-swagger-openapi-export.yml`。
