# Requirements Traceability Matrix

## Story: 1.1 - Yarn 3 Workspaces 与 Node 20 LTS

### Coverage Summary

- Total Requirements: 3
- Fully Covered: 3 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: `.yarnrc.yml` 配置 `nodeLinker: node-modules`；执行 `corepack enable`

- **Coverage: FULL**
- test_mappings:
  - test_file: '.github/workflows/quality.yml'
    test_case: 'contracts job :: Setup Node & Corepack'
    given: 'Quality Gates 工作流触发，contracts job 在 Ubuntu Runner 上执行'
    when: 'actions/setup-node@v4 配置 Node 20 并运行 `corepack enable`，随后步骤 `Verify Yarn config guards` 执行'
    then: '`yarn config get nodeLinker` 输出写入 `reports/nodeLinker.txt` 并断言为 `node-modules`'
    coverage: full
- 说明：CI 阶段直接断言 nodeLinker，并在构件中保留证据，覆盖测试设计 1.1-INT-001 与 1.1-UNIT-003。

#### AC2: 根 `packageManager` 指定 yarn@3；工作区识别 `apps/*` 与 `packages/*`

- **Coverage: FULL**
- test_mappings:
  - test_file: '.github/workflows/quality.yml'
    test_case: 'contracts job :: Verify Yarn config guards'
    given: '`yarn config get nodeLinker` 守护通过后继续执行'
    when: '`yarn workspaces list --json` 输出写入 `reports/workspaces.json`'
    then: '`node scripts/workspace-smoke.cjs` 校验所有工作区 manifest，若缺失/不匹配则失败'
    coverage: integration
  - test_file: 'package.json'
    test_case: '`yarn test:web` smoke`
    given: '开发或 CI 运行 Yarn 测试脚本'
    when: '执行 `node scripts/workspace-smoke.cjs --workspace @cdm/web`'
    then: '校验 `apps/web/package.json` name/private 字段，若不符合立即失败'
    coverage: unit
  - test_file: 'package.json'
    test_case: '`yarn test:api` smoke`
    given: '开发或 CI 运行 Yarn 测试脚本'
    when: '执行 `node scripts/workspace-smoke.cjs --workspace @cdm/api`'
    then: '校验 `apps/api/package.json` manifest'
    coverage: unit

#### AC3: CI 缓存 Yarn 与 Node；锁文件稳定

- **Coverage: FULL**
- test_mappings:
  - test_file: '.github/workflows/quality.yml'
    test_case: 'contracts job :: Yarn cache + immutable install'
    given: 'Quality Gates 工作流针对 main/next/develop 分支运行'
    when: '`Install dependencies (immutable)` 记录 `yarn_install_seconds`，`Record Yarn cache metadata` 输出 `cache-hit=${{ steps.setup_node.outputs.cache-hit }}`'
    then: '锁文件漂移时 `git diff --exit-code yarn.lock` 失败，同时缓存命中统计写入 `reports/yarn-cache.txt`'
    coverage: full

### Critical Gaps

目前无关键缺口；所有验收标准均具备自动化覆盖。

### Test Design Recommendations

- 维持 `reports/*.txt` 与 `reports/workspaces.json` 的归档，确保回归时可追溯。
- 随后可在 smoke 脚本中扩展对新工作区/脚手架的校验，以保持覆盖面。

### Risk Assessment

- **Low Risk**: 依赖安装性能由 `reports/yarn-install-metrics.txt` 观测；CI 守护可及时发现偏差。
