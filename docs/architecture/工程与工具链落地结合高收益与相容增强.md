# 工程与工具链落地（结合高收益与相容增强）

## 版本与环境
- Node 固定：Volta 固定 Node 20.14.0；同时提供 `.nvmrc`
- 包管理：Yarn 3（Berry）+ Workspaces，安装使用 `yarn install --immutable`
- Registry 建议：本地可用镜像（如 npmmirror），CI 使用官方 registry 并开启完整性校验

## Monorepo 与目录
- 工具：Yarn Workspaces + Turborepo（任务编排与缓存）；不引入 Lerna（避免与 Changesets 职责重叠）
- 包结构（新增两个契约产物包）：
  - `apps/web`（Next.js 14）
  - `apps/api`（NestJS 10）
  - `apps/worker`（BullMQ 队列 Worker）
  - `packages/shared`（共享类型/常量/工具）
  - `packages/config`（ESLint/TSConfig/Prettier/commitlint 配置）
  - `packages/api-types`（由 OpenAPI 生成的 TS 类型）
  - `packages/api-client`（由 OpenAPI 生成的前端/服务端 API 客户端）
  - `infrastructure/`（部署脚本/IaC，可选）

## TypeScript 配置分层
- 根通用 `tsconfig.base.json`（严格模式）；`tsconfig.paths.json` 统一别名
- Server：`tsconfig.server.json`（Node 兼容，CommonJS 或逐步过渡 ESM）
- Client：`tsconfig.client.json`（React/DOM）

## 契约与 API 参考流水线
- 服务端导出：`GET /api/__openapi.json`（或 yaml）
- 生成脚本：
  - `api:types` → `packages/api-types/src/index.ts`
  - `api:client` → `packages/api-client`（axios 客户端）
- 规范：前端禁止手写 URL/类型，统一引用生成产物
- CI：Spectral Lint + 基线 Diff（对 `docs/openapi.baseline.json`）

## CI/CD 与质量门槛（强制）
- 必过步骤：`lint`、`prettier:check`、`type-check`、`test:web`、`test:api`、`build`、`api:openapi` + `api:spectral` + `api:diff`
- 提交规范：Conventional Commits + `commitlint`（type/scope 白名单），拒绝不合规提交
- 分支保护：`main/next/develop` 禁止直推，至少 1–2 Reviewer，所有状态检查通过才可合并
- 覆盖率：前后端分别产出覆盖率并在 CI 上传（或合并后上传）

## 测试策略
- 前端：Vitest + Testing Library；目录 `__tests__`
- 后端：Jest + supertest；目录 `__tests__`
- E2E：Playwright（手动工作流触发），产物：截图/trace，默认输出到 `storage/playwright`

## 可观测性与日志
- 日志：Pino（结构化 JSON）+ OpenTelemetry 上下文字段（`traceId/spanId/reqId`），禁止打印敏感信息
- 响应头：统一回传 `x-trace-id`
- 指标：Prometheus `/metrics`，采集 QPS/P95/P99/错误率/队列滞留/作业成功率
- Tracing：OTLP 默认导出（可接入 Tempo/Jaeger/New Relic 等）

## 容器与本地栈
- 镜像：多阶段构建（Builder/Runner），推荐 API/SSR 与静态服务分镜像
- 本地 Compose：Postgres、Redis、API、Worker（用于 E2E 与演示）

## 协作模板与检查单
- 引入 Issue/PR 模板与“一次性落地清单”，把“契约/日志/CI 门禁”列为必须项

---
