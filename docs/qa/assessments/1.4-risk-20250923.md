# 风险画像：Story 1.4 Prisma 基线与迁移

日期：2025-09-23｜评审：Quinn（测试架构师）

## 概览

- 风险总数：6
- 高风险：4
- 中风险：2
- 低风险：0
- 风险评分：55 / 100（起始 100，4×高风险扣 40，2×中风险扣 5）

## 风险矩阵

| 风险 ID  | 描述                                                          | 概率   | 影响   | 评分 | 等级 |
| -------- | ------------------------------------------------------------- | ------ | ------ | ---- | ---- |
| MIG-301  | 初始迁移缺失，`schema.prisma` 尚无对应 migrations 目录        | 高 (3) | 中 (2) | 6    | 高   |
| TECH-301 | Prisma Schema 未落实 snake_case / 指定索引要求                | 高 (3) | 中 (2) | 6    | 高   |
| TECH-302 | 未安装 `prisma` CLI 与 `@prisma/client`，测试脚本无法运行     | 中 (2) | 高 (3) | 6    | 高   |
| OPS-301  | CI `quality.yml` 尚无数据库迁移作业，缺少 Postgres 服务配置   | 中 (2) | 高 (3) | 6    | 高   |
| OPS-302  | `DATABASE_URL` 等凭据未提供 `.env.example` / 校验机制         | 中 (2) | 中 (2) | 4    | 中   |
| DATA-301 | 初始迁移覆盖范围过广（8+ 业务模型），缺乏拆分策略，回滚难度高 | 中 (2) | 中 (2) | 4    | 中   |

## 风险详情与缓解

### MIG-301：初始迁移缺失

- **迹象**：`apps/api/prisma/migrations/` 目录不存在，`schema.prisma` 已包含 250+ 行模型。
- **后果**：`prisma migrate deploy` 无法应用模型变化；CI 无法验证数据库结构，AC1~AC3 均受阻。
- **缓解**：
  - 使用 Yarn 3 环境执行 `yarn workspace @cdm/api prisma migrate dev -n init`，提交 SQL 产物。
  - 在 PR 中附 `prisma migrate deploy` / `prisma migrate diff --to-empty --script` 日志，证明可重复。

### TECH-301：命名/索引约束未落实

- **迹象**：`schema.prisma` 中字段命名使用 camelCase（如 `moduleId`、`baselineId`），未添加 snake_case `@map`；`Requirement.status`／`Metric.name`／`RbomNode.code` 缺少明确索引。架构任务要求使用 snake_case 并补齐高频字段索引。
- **后果**：数据库实际列名违背约定；查询性能与约束无法满足 AC2。
- **缓解**：
  - 为模型与字段补充 `@@map` / `@map` 保持 snake_case。
  - 依照查询模式添加索引（必要时使用 `@@index([status])`、`@@unique`、`@@index([code], map: ...)` 或 raw SQL 迁移以创建 GIN 索引）。

### TECH-302：Prisma 依赖缺失

- **迹象**：`apps/api/package.json` 未包含 `prisma` / `@prisma/client`；根 `package.json` 无 `prisma:*` 脚本。
- **后果**：命令 `yarn prisma:migrate`、`yarn prisma:generate` 等无法执行，生成客户端失败；CI 作业也会报错。
- **缓解**：
  - 在 workspace 安装 `prisma`（devDependency）与 `@prisma/client`（dependency）；添加 yarn scripts（`prisma:generate`、`prisma:migrate`、`prisma:rollback`）。
  - 在 README/Docs 记录安装步骤和命令约束。

### OPS-301：CI 缺少数据库迁移作业

- **迹象**：`.github/workflows/quality.yml` 尚无 `db-migrate` 作业或 Postgres 服务定义，当前作业仅处理 contracts/security/tests。
- **后果**：AC3 要求的 `prisma migrate deploy` + 回滚验证无法自动执行；迁移质量无 CI 保障。
- **缓解**：
  - 在 workflow 中新增 job，声明 `services.postgres`（或使用 `docker-compose`）并运行 `prisma generate / migrate deploy / migrate diff`。
  - 上传迁移日志、diff SQL，必要时将 job 置为必选检查。

### OPS-302：环境变量缺乏校验

- **迹象**：仓库不存在 `.env.example`，也未引入 `dotenv-safe` / `envalid`；`schema.prisma` 依赖 `DATABASE_URL`。
- **后果**：本地或 CI 可能在缺失变量时静默失败；安全性与回滚流程受影响。
- **缓解**：
  - 提供 `.env.example` + `README` 指南，并通过 `dotenv-safe` / `envalid` 在应用启动时校验。
  - CI job 显式设置 `DATABASE_URL`，避免默认空值。

### DATA-301：初始迁移范围庞大

- **迹象**：`schema.prisma` 包含 Requirement/Metric/RbomNode 以外的大量模型（Diff、ChangePackage、Notification、AuditLog 等）。
- **后果**：初始迁移脚本过大且与当前业务范围脱节，增加回滚复杂度；后续故事调整模型需重迁。
- **缓解**：
  - 与架构/PO 确认首个迁移的最小范围，考虑拆分为多个迁移批次。
  - 在迁移说明中标注未来扩展计划，避免一次性引入全部模型。

## 风险驱动的测试策略

1. **P0（高风险）**：
   - 在 CI 与本地执行 `prisma migrate deploy`、`prisma migrate diff --to-empty --script`。
   - 验证索引存在（`SELECT relname FROM pg_indexes` / `EXPLAIN`）。
   - 运行 Jest 集成测试 (`apps/api/__tests__/migration.spec.ts`) 针对核心表。
2. **P1（中风险）**：
   - 校验 `.env` / `DATABASE_URL` 配置，提供错误时的友好提示。
   - 审查初始迁移的拆分策略，必要时拆为多个 SQL 文件。

## 必须在交付前完成的缓解项

- 安装 Prisma 依赖并提交 `prisma generate`/`migrate` 脚本及 SQL。
- 更新 schema 命名与索引，确保满足 snake_case 与性能要求。
- 在 CI 加入 `db-migrate` 作业，声明 Postgres 服务并上传迁移日志。
- 提供 `.env.example` 与文档，确保 `DATABASE_URL` 和凭据有清晰配置。

---

Risk profile: docs/qa/assessments/1.4-risk-20250923.md
