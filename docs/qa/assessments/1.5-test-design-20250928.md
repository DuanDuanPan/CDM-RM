# 测试设计：故事 1.5 Swagger/OpenAPI 导出

日期：2025-09-28｜设计者：Quinn（Test Architect）

## 测试策略概览
- 场景总数：8
- 按层级：单元 1｜集成 6｜端到端 1
- 按优先级：P0 3｜P1 4｜P2 1
- 重点目标：验证契约与实现同步、生成产物完整、CI 门禁可靠、敏感端点屏蔽。

## 按验收准则拆解
### AC1：暴露 `/api/__openapi.json`
| ID | 层级 | 优先级 | 测试内容 | 关联风险 | 说明 |
|----|------|--------|----------|----------|------|
| 1.5-INT-001 | 集成 | P0 | 启动 Nest 应用调用 GET `/api/__openapi.json`，断言 200、`content-type: application/json`，并核对 paths 列表覆盖所有注册控制器 | TECH-OPENAPI-001 | 使用 supertest + 自动枚举控制器反射元数据 |
| 1.5-UNIT-001 | 单元 | P1 | 对 `export-openapi.js`/Swagger 配置执行快照，确认仅包含允许 tags、`servers` 为外网地址、隐藏内部模块 | SEC-OPENAPI-001 | Jest 对 DocumentBuilder 配置做 schema 断言 |

### AC2：生成类型与客户端包
| ID | 层级 | 优先级 | 测试内容 | 关联风险 | 说明 |
|----|------|--------|----------|----------|------|
| 1.5-INT-002 | 集成 | P1 | 运行 `yarn api:types`，断言 `packages/api-types/src/index.ts` 更新且含 `requirements`、`rbom`、`diffs`、`changes` 类型 | DATA-OPENAPI-001 | 使用 Vitest 快照 + AST 校验核心枚举 |
| 1.5-INT-003 | 集成 | P1 | 运行 `yarn api:client`，检查生成的 axios 客户端导出并在 `apps/web` 服务层引入成功 | DATA-OPENAPI-001 | 结合 `ts-node` 运行 smoke call 至 mock server |
| 1.5-INT-006 | 集成 | P2 | 在 `apps/web` 执行 `yarn build --filter apps/web`，确保使用生成客户端构建通过且无手写 REST | DATA-OPENAPI-001 | 可利用 ESLint 规则检查硬编码路径 |

### AC3：Spectral Lint 通过；OpenAPI diff 报告生成
| ID | 层级 | 优先级 | 测试内容 | 关联风险 | 说明 |
|----|------|--------|----------|----------|------|
| 1.5-INT-004 | 集成 | P0 | 执行 `yarn api:spectral`，验证 `reports/spectral.sarif` 生成且无 Blocker；模拟违规 rule 预期 fail | SEC-OPENAPI-001 | 在 CI 中对 SARIF 进行断言，拉取 artifact 校验 |
| 1.5-INT-005 | 集成 | P1 | 执行 `yarn api:diff` 比较 `docs/openapi.baseline.json`，断言 `reports/openapi-diff.txt` 包含分类摘要并在 breaking change 时返回非零 | TECH-OPENAPI-001 | 结合 CLI `--fail-on-breaking` 参数 |
| 1.5-E2E-001 | 端到端 | P0 | 运行 `.github/workflows/quality.yml` contracts 作业（冷缓存），确认 Spectral + diff + types/client 均产生产物并上传 artifact；验证失败时 PR 被阻断 | OPS-OPENAPI-001 | 使用 GitHub Actions 工作流测试环境或 act 复现 |

## 风险覆盖
- TECH-OPENAPI-001：1.5-INT-001、1.5-INT-005、1.5-E2E-001
- SEC-OPENAPI-001：1.5-UNIT-001、1.5-INT-004
- DATA-OPENAPI-001：1.5-INT-002、1.5-INT-003、1.5-INT-006
- OPS-OPENAPI-001：1.5-E2E-001

## 推荐执行顺序
1. P0 集成/端到端（1.5-INT-001 → 1.5-INT-004 → 1.5-E2E-001）
2. P1 集成（1.5-INT-002 → 1.5-INT-003 → 1.5-INT-005）
3. P1 单元（1.5-UNIT-001）
4. P2 集成（1.5-INT-006）

## 额外说明
- 将 P0 场景纳入 `quality.yml`，对 breaking change 设置强制失败。
- 建议对 1.5-UNIT-001 配置 Spectral 自定义规则测试，确保安全校验不会失效。
- 对 `apps/web` 的客户端消费引入 ESLint 扩展规则，持续防止手写 REST。

```yaml
test_design:
  scenarios_total: 8
  by_level:
    unit: 1
    integration: 6
    e2e: 1
  by_priority:
    p0: 3
    p1: 4
    p2: 1
  coverage_gaps: []
```

Test design matrix: qa.qaLocation/assessments/1.5-test-design-20250928.md
P0 tests identified: 3
