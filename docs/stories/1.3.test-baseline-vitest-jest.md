# Story 1.3: 测试基线（Vitest/Jest）

## Status

Done

## Story

**As a** Developer,
**I want** 为 web/api 建立 Vitest 与 Jest 的测试与覆盖率基线,
**so that** 回归可以通过 CI 自动化验证并输出覆盖率指标。

## Acceptance Criteria

1. web 使用 Vitest；api 使用 Jest 或 Vitest（二选一）。
2. `yarn test:client` / `yarn test:server` 执行通过并生成覆盖率报告，低于门槛即失败。
3. CI 启动最小测试矩阵并上传覆盖率产物。

## Tasks / Subtasks

- [x] 建立 Web 端 Vitest 基线（AC: 1）[Source: architecture/测试与覆盖率testing-coverage.md#测试-覆盖率testing--coverage]
  - [x] 在 `apps/web` 安装 `vitest`、`@vitest/coverage-v8`、`jsdom`、`@testing-library/react`、`@testing-library/jest-dom`、`@testing-library/user-event` 等依赖，并通过根/子包 `package.json` 正确声明。[Source: architecture/技术栈tech-stack.md#技术栈tech-stack]
  - [x] 新增 `apps/web/vitest.config.ts`（含 jsdom、路径别名、覆盖率设置）并在 `apps/web/__tests__/` 下提供示例组件/工具测试。[Source: architecture/前端架构frontend-architecture.md#组件组织目录约定]
  - [x] 更新 `apps/web/package.json` 与根脚本，使 `yarn test:client` 通过 `yarn workspace @cdm/web vitest run --coverage` 调用并启用覆盖率阈值 ≥80%。[Source: architecture/开发与运行流程development-workflow.md#常用脚本建议在根-packagejson-提供][Source: architecture/adr/0001-epic1-decisions.md#决策与指引]
- [x] 构建 API 端 Jest 基线（AC: 1）[Source: architecture/测试与覆盖率testing-coverage.md#测试-覆盖率testing--coverage]
  - [x] 在 `apps/api` 安装 `jest`、`ts-jest`、`@types/jest`、`supertest`、`@types/supertest`、`cross-env`，配置 `jest.config.ts`（Node 环境、ts-jest、覆盖率 ≥80%）。[Source: architecture/技术栈tech-stack.md#技术栈tech-stack]
  - [x] 提供最小 Controller/Service 单元与集成示例测试，放置于 `apps/api/__tests__/` 并演示数据库 mock。[Source: architecture/后端架构backend-architecture.md#服务架构nestjs-传统服务]
  - [x] 更新 `apps/api/package.json` 与根脚本，使 `yarn test:server` 通过 `cross-env NODE_ENV=test yarn workspace @cdm/api jest --runInBand --coverage` 生成覆盖率报告。[Source: architecture/开发与运行流程development-workflow.md#常用脚本建议在根-packagejson-提供][Source: architecture/工程与工具链落地结合高收益与相容增强.md#测试策略]
- [x] 整理覆盖率与测试脚本治理（AC: 2）[Source: architecture/工程与工具链落地结合高收益与相容增强.md#cicd-与质量门槛强制]
  - [x] 在根 `package.json` 调整测试脚本（去除 smoke）并新增 `coverage` 汇总脚本，确保低于阈值自动失败，脚本调用统一通过 `yarn workspace` 与 `cross-env`。[Source: architecture/adr/0001-epic1-decisions.md#决策与指引]
  - [x] 配置 `vitest` 与 `jest` 输出 cobertura/json-summary 产物至 `reports/coverage/web` 与 `reports/coverage/api` 目录供 CI 上传。[Source: architecture/测试与覆盖率testing-coverage.md#测试-覆盖率testing--coverage]
  - [x] 更新 `README.md` / `docs/development.md` 的“质量门槛”小节，明确覆盖率阈值（80%）并指导开发者执行 `yarn test:client && yarn test:server`。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#协作模板与检查单]
- [x] 将测试基线接入 CI（AC: 3）[Source: architecture/监控与检查清单结果ci-自动化.md#github-actions-工作流示例githubworkflowsqualityyml]
  - [x] 在 `.github/workflows/quality.yml` 增加 `test` 作业：使用 Node 20、复用缓存，执行 `yarn test:client --coverage --no-threads`（Vitest）与 `yarn test:server --coverage --runInBand`（Jest），并通过 `actions/upload-artifact` 上传 `reports/coverage/**`（名称示例：`coverage-web`、`coverage-api`）。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#cicd-与质量门槛强制]
  - [x] 在 CI 中记录测试耗时、覆盖率结果，并将阈值不达标时直接失败（含注释说明研判步骤）；打印 `coverage-summary.json` 摘要以便审阅；同步注明现有 `contracts` 作业中的 `yarn test:web` / `yarn test:api` 将迁移到 `test` 作业或关闭重复步骤，确保职责清晰。[Source: architecture/adr/0001-epic1-decisions.md#决策与指引]
  - [x] 为 Playwright 预留占位说明（可选触发），确保与未来 E2E 故事兼容但默认跳过。[Source: architecture/测试与覆盖率testing-coverage.md#测试-覆盖率testing--coverage]

## Dev Notes

- **Previous Story Insights：** Story 1.2 已上线 Husky + lint-staged + commitlint，提交前会自动运行 `eslint --fix` 与 `prettier --write`；本故事需在后续迭代中考虑是否将 `yarn test:*` 添加进 pre-commit 的可选阶段。[Source: stories/1.2.code-standards-commit-checks.md#dev-notes]
- **Data Models：** 当前仅需最小示例模型，可使用 mock/内存对象，架构文档未定义具体 schema。
- **API Specifications：** 无新增 API 契约要求，示例测试可针对现有样板 Controller/Service。[Source: architecture/高层架构high-level-architecture.md#架构与设计模式已选]
- **Component Specifications：** Web 测试需遵循组件目录约定与 shadcn/ui/Tailwind 的通用模式，必要时 mock Next.js runtimes。[Source: architecture/前端架构frontend-architecture.md#组件组织目录约定]
- **File Locations：** 单元/集成测试统一放在各应用 `__tests__` 目录；覆盖率报告写入 `reports/coverage/web` 与 `reports/coverage/api`，保持与 CI 工件路径一致。[Source: architecture/测试与覆盖率testing-coverage.md#测试-覆盖率testing--coverage]
- **Testing Requirements：** 前端使用 Vitest + Testing Library，后端使用 Jest + supertest；覆盖率低于 80% 直接失败，并在 CI 上传报告。[Source: architecture/技术栈tech-stack.md#技术栈tech-stack][Source: architecture/adr/0001-epic1-decisions.md#决策与指引]
- **Technical Constraints：** 质量门槛需包含 `test:web`、`test:api`，与 lint/prettier/type-check/contract 检查一并执行。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#cicd-与质量门槛强制]
- **Structure Notes：** `scripts/workspace-smoke.cjs` 在 Story 1.1 中用于临时 smoke，可迭代为调用真实测试或保留为 fallback；更新脚本时注意是否保留向后兼容。[Source: stories/1.1.yarn-3-workspaces-node-20-lts.md#dev-notes]
- **Implementation Tips：** 建议创建 `apps/web/vitest.setup.ts` 与 `apps/api/jest.setup.ts` 引入 `@testing-library/jest-dom`、全局 mock 等，并在 `vitest.config.ts` / `jest.config.ts` 的 `setupFiles` 中引用；同时开启别名解析（引用 `tsconfig.paths.json`）与 `--runInBand` 控制 CI 并发。[Source: architecture/工程与工具链落地结合高收益与相容增强.md#测试策略]

### Testing

- 最小样例：构建一个纯函数 + React 组件测试，确保 Vitest + Testing Library + jest-dom 链路可用；API 侧提供一个返回 200 的健康检查或样板服务测试（supertest）。[Source: architecture/测试与覆盖率testing-coverage.md#测试-覆盖率testing--coverage]
- 验证覆盖率：运行 `yarn test:client --coverage`、`yarn test:server --coverage` 并确认低于 80% 时退出码非 0，覆盖率报告应分别生成于 `reports/coverage/web` 与 `reports/coverage/api` 并由 CI 上传。[Source: architecture/adr/0001-epic1-decisions.md#决策与指引][Source: architecture/监控与检查清单结果ci-自动化.md#github-actions-工作流示例githubworkflowsqualityyml]
- CI 产物检查：在测试作业执行后核对 `actions/upload-artifact` 日志，确保 `coverage-web`、`coverage-api` 工件存在且包含 lcov、cobertura、summary 文件。[Source: architecture/监控与检查清单结果ci-自动化.md#github-actions-工作流示例githubworkflowsqualityyml]

## Change Log

| Date       | Version | Description                           | Author             |
| ---------- | ------- | ------------------------------------- | ------------------ |
| 2025-09-23 | v1.2    | 标记故事状态为 Done                   | Bob (Scrum Master) |
| 2025-09-23 | v1.1    | 标记故事状态为 Ready for Done         | Bob (Scrum Master) |
| 2025-09-23 | v1.0    | 实现 Vitest/Jest 测试基线并提交审查   | James (Dev Agent)  |
| 2025-09-23 | v0.3    | PO 审核通过，转入待开发               | Bob (Scrum Master) |
| 2025-09-23 | v0.2    | 补充覆盖率依赖、CI 工件上传与脚本细节 | Bob (Scrum Master) |
| 2025-09-23 | v0.1    | 创建故事草稿                          | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

- Codex GPT-5

### Debug Log References

- `yarn test:client`
- `yarn test:server`
- `yarn coverage`

### Completion Notes List

- apps/web 已接入 Vitest + Testing Library，示例测试覆盖率 100%，覆盖率阈值设置为 80%。
- apps/api 建立 Nest 样板配合 Jest/supertest，单元与集成测试通过并生成覆盖率报告。
- 根级脚本替换 smoke，提供 `test:client`、`test:server`、`coverage`，统一写入 `reports/coverage/*`。
- CI workflow 新增 `test` 作业，拆分 contracts 流程并上传 `coverage-web`、`coverage-api` 工件及耗时指标。
- 保留向后兼容脚本别名（`yarn test:web` / `yarn test:api`），并在 README 增补排错说明，QA 反馈已汇总至 `docs/qa/assessments/1.3-dev-response-20250923.md`。

### File List

- `.github/workflows/quality.yml`
- `.gitignore`
- `README.md`
- `package.json`
- `yarn.lock`
- `scripts/coverage-summary.cjs`
- `apps/web/package.json`
- `apps/web/tsconfig.json`
- `apps/web/vitest.config.ts`
- `apps/web/vitest.setup.ts`
- `apps/web/scripts/run-vitest.cjs`
- `apps/web/src/components/Greeting.tsx`
- `apps/web/__tests__/Greeting.test.tsx`
- `apps/api/package.json`
- `apps/api/tsconfig.json`
- `apps/api/jest.config.ts`
- `apps/api/jest.setup.ts`
- `apps/api/src/app.module.ts`
- `apps/api/src/app.controller.ts`
- `apps/api/src/app.service.ts`
- `apps/api/__tests__/app.controller.spec.ts`
- `apps/api/__tests__/app.service.spec.ts`
- `docs/stories/1.3.test-baseline-vitest-jest.md`

## QA Results

### Review Date: 2025-09-23

### Reviewed By: Quinn (Test Architect)

### 验收验证

- `corepack yarn install --immutable` 成功，随后执行：
  - `corepack yarn test:client -- --no-threads`
  - `corepack yarn test:server`
  - `corepack yarn coverage`
    三条命令均通过并生成覆盖率摘要（web/api 本地覆盖率 100%，阈值设为 80%）。
- `.github/workflows/quality.yml` 新增 `tests` 作业，安装依赖后运行 Vitest/Jest，上传 `coverage-web`、`coverage-api`、`coverage-metrics` 工件。
- README “开发流程” 段已更新，指引开发者在提交前运行 `yarn test:client && yarn test:server` 并解释覆盖率要求。

### 主要发现

1. **测试基线齐备（Severity: Low）** —— 前后端分别提供 Vitest + Testing Library 与 Jest + supertest 示例，覆盖率阈值配置生效；脚本通过 `yarn workspace` 统一调用。
2. **CI 工件完整（Severity: Low）** —— tests 作业写入覆盖率目录后上传工件，并记录执行耗时，便于后续监控。
3. **向后兼容处理得当（Severity: Low）** —— 保留 `yarn test:web` / `yarn test:api` alias，避免现有流程立即失效，同时文档说明日后迁移计划。

### 建议后续动作

- 持续关注测试作业耗时（`reports/vitest-metrics.txt`、`reports/jest-metrics.txt`），若超出预期可拆分矩阵或开启并发。
- 随着业务代码增长，及时扩展示例测试或新增 smoke 套件，防止覆盖率仅由样例支撑。
- 在未来的 E2E Story 中复用现有结构，新增 Playwright/端到端测试时注意工件命名与指标收集。

### Gate 结论

- 建议 Gate：**PASS** —— 三项验收标准均满足，测试与覆盖率基线可在 CI 中稳定运行。
- 详见 `docs/qa/gates/1.3-test-baseline-vitest-jest.yml`。

Gate: PASS → docs/qa/gates/1.3-test-baseline-vitest-jest.yml
